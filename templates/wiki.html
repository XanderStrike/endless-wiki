<!DOCTYPE html>
<html>
<head>
    <title>{{.Title}} - Endless Wiki</title>
    <style>
        body { 
            font-family: Georgia, serif; 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px; 
            line-height: 1.6;
        }
        .header { 
            border-bottom: 1px solid #ccc; 
            margin-bottom: 20px; 
            padding-bottom: 10px;
        }
        .header h1 { 
            margin: 0; 
            color: #333; 
        }
        .nav { 
            margin-bottom: 20px; 
        }
        .nav a { 
            color: #007cba; 
            text-decoration: none; 
            margin-right: 15px;
        }
        .nav a:hover { 
            text-decoration: underline; 
        }
        .content { 
            font-size: 16px; 
        }
        .content h1, .content h2, .content h3 { 
            color: #333; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 5px;
        }
        .content a { 
            color: #007cba; 
            text-decoration: none; 
        }
        .content a:hover { 
            text-decoration: underline; 
        }
        .content p { 
            margin-bottom: 15px; 
        }
        .content ul, .content ol { 
            margin-bottom: 15px; 
        }
        .loading { 
            color: #666; 
            font-style: italic; 
        }
        .loading::after {
            content: '';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        .selection-popup {
            position: absolute;
            background: #007cba;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: none;
            white-space: nowrap;
            max-width: 300px;
            text-overflow: ellipsis;
            overflow: hidden;
        }
        .selection-popup:hover {
            background: #005a87;
        }
        .selection-popup::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border: 5px solid transparent;
            border-top-color: #007cba;
        }
        .content {
            user-select: text;
        }
    </style>
</head>
<body>
    <div class="nav">
        <a href="/">Home</a>
        <a href="javascript:history.back()">Back</a>
        Select any text to make it the title of your next article (once generation completes).
    </div>
    
    <div class="content" id="content">
        <div class="loading">Generating article</div>
    </div>
    
    <div id="selectionPopup" class="selection-popup">
        Go to article â†’
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const eventSource = new EventSource('/stream/{{.Title}}');
        const contentDiv = document.getElementById('content');
        const popup = document.getElementById('selectionPopup');
        let selectedText = '';
        
        eventSource.onmessage = function(event) {
            // Handle default messages
        };
        
        eventSource.addEventListener('content', function(event) {
            const content = event.data.replace(/\\n/g, '\n');
            // Parse markdown and render as HTML
            const htmlContent = marked.parse(content);
            contentDiv.innerHTML = htmlContent;
        });
        
        eventSource.addEventListener('complete', function(event) {
            eventSource.close();
        });
        
        eventSource.addEventListener('error', function(event) {
            contentDiv.innerHTML = '<p style="color: red;">Error generating article. Please try again.</p>';
            eventSource.close();
        });
        
        eventSource.onerror = function(event) {
            contentDiv.innerHTML = '<p style="color: red;">Connection error. Please try again.</p>';
            eventSource.close();
        };
        
        // Handle text selection
        document.addEventListener('mouseup', function(event) {
            // Don't interfere if clicking on the popup
            if (event.target === popup || popup.contains(event.target)) {
                return;
            }
            
            setTimeout(function() {
                const selection = window.getSelection();
                const text = selection.toString().trim();
                
                if (text.length > 0 && text.length <= 100) {
                    selectedText = text;
                    const range = selection.getRangeAt(0);
                    const rect = range.getBoundingClientRect();
                    
                    // Position popup above the selection
                    popup.style.left = Math.max(10, rect.left + rect.width / 2 - 75) + 'px';
                    popup.style.top = (rect.top - 50 + window.scrollY) + 'px';
                    popup.style.display = 'block';
                    popup.textContent = 'Go to "' + text + '"';
                } else {
                    popup.style.display = 'none';
                }
            }, 100);
        });
        
        // Handle popup click
        popup.addEventListener('click', function() {
            if (selectedText) {
                window.location.href = '/wiki/' + encodeURIComponent(selectedText);
            }
        });
        
        // Hide popup when clicking elsewhere
        document.addEventListener('click', function(event) {
            if (event.target !== popup && !popup.contains(event.target)) {
                popup.style.display = 'none';
                // Don't clear selection immediately, let it persist briefly
            }
        });
        
        // Hide popup when selection changes to empty (but with delay to allow popup clicks)
        document.addEventListener('selectionchange', function() {
            setTimeout(function() {
                const selection = window.getSelection();
                if (selection.toString().trim().length === 0 && popup.style.display === 'block') {
                    // Only hide if we're not hovering over the popup
                    if (!popup.matches(':hover')) {
                        popup.style.display = 'none';
                    }
                }
            }, 200);
        });
    </script>
</body>
</html>
